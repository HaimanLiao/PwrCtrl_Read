/*
* *******************************************************************************
*	@(#)Copyright (C) 2019-2030
* *******************************************************************************
*/
/*
* *******************************************************************************
* FILE NAME		: EXPORT_CTRL
* SYSTEM NAME	: 
* BLOCK NAME	: 
* PROGRAM NAME	: 
* MODULE FORM	: 
* -------------------------------------------------------------------------------
* AUTHOR		: zhangjun 
* DEPARTMENT	: 
* DATE			: 2019-5-6 16:38
* *******************************************************************************
*/


/*
* *******************************************************************************
*                                  Include
* *******************************************************************************
*/
#include "export_ctrl.h"
#include "dlog.h"
#include "export.h"
#include "log_sys.h"
#include "timer.h"

//#define GPIO_OUT_NUM			3

/*实际对应IO,单独控制*/
//#define 	IO_K_LED1		"89"	// GPIO3_IO25
//#define 	IO_K_LED2		"90"	// GPIO3_IO26
//#define 	IO_K_LED3		"45"	// GPIO2_13

/*
* *******************************************************************************


*                                  Public variables
* *******************************************************************************
*/

/*
* *******************************************************************************
*                                  Private variables
* *******************************************************************************
*/
//static unsigned int GPIO_MUX_REG[GPIO_OUT_NUM] = {0x20E0044, 0x20E0050, 0x20E0058};
//static unsigned int GPIO_PAD_REG[GPIO_OUT_NUM] = {0x20E02D0, 0x20E02DC, 0x20E02E4};

static pthread_t thread_export;

static double g_ADvoltage[2] = {0};	// AD8, AD9

static int 	g_mcpfd = 0;

static char g_gpa = 0;		// 输入检测
static char g_gpb = 0;		// 输入检测

static char g_ola = 0;		// 输出检测
static char g_olb = 0;		// 输出检测

/****************枪温数组****************/
unsigned int Temp_Table_Pt1000[] =
{
	767,771,775,779,783,787,791,795,799,803,	//-50
	807,811,815,819,823,827,821,835,839,843,	//-40
	847,851,855,859,862,866,870,874,878,882,	//-30
	886,890,894,898,902,906,910,914,918,922,	//-20
	926,929,933,937,941,945,949,953,957,961,	//-10
	965,969,973,977,980,984,988,992,996,1000,	//0
	1004,1008,1012,1016,1020,1023,1027,1031,1035,// 10
	1039,1043,1047,1051,1055,1058,1062,1066,1070,1074,// 20
	1078,1082,1086,1090,1093,1097,1101,1105,1109,1113,//30
	1117,1121,1124,1128,1132,1136,1140,1144,1148,1152,//40
	1155,1159,1163,1167,1171,1175,1179,1182,1186,1190,//50
	1194,1198,1202,1206,1209,1213,1217,1221,1225,1229,//50
	1232,1236,1240,1244,1248,1252,1255,1259,1263,1267,//60
	1271,1275,1278,1282,1286,1290,1294,1298,1301,1305,//70
	1309,1313,1317,1320,1324,1328,1332,1337,1339,1343,//80
	1347,1351,1355,1358,1362,1366,1370,1374,1377,1381,//90
	1385,1389,1393,1396,1400,1404,1408,1412,1415,1419,//100
	1423,1427,1430,1434,1438,1442,1446,1449,1453,1457,//110
	1461,1464,1468,1472,1476,1480,1483,1487,1491,1495,//120
	1498,1502,1506,1510,1513,1517,1521,1525,1529,1531,//130
	1536,1540,1543,1547,1551,1555,1558,1562,1566,1570,//140
	1573,1577,1581,1584,1588,1592,1596,1599,1603,1607,//150
	1611,1614,1618,1622,1625,1629,1633,1637,1640,1644,//160
	1648,1651,1655,1659,1663,1666,1670,1674,1677,1681,//170
	1685,1688,1692,1696,1670,1703,1707,1711,1714,1718,//180
	1722,1725,1729,1733,1736,1740,1744,1748,1751,1755,//190
	1759,1762,1766,1770,1773,1777,1781,1784,1788,1792,//200
	1795,1799,1803,1806,1810,1814,1817,1821,1825,1828,//210
	1832,1836,1839,1843,1846,1850,1854,1857,1861,1865,//220
	1868,1872,1876,1879,1883,1887,1890,1894,1897,1901,//230
	1905,1908,1912,1916,1919,1923,1926,1930,1934,1937,//240
	1941,1945,1948,1952,1955,1959,1963,1966,1970,1974,//250
	1977,1981,1984,1988,1992,1995,1999,2002,2006,2010,//260
	2013,2017,2020,2024,2028,2031,2035,2038,2042,2045,//270
	2049,2053,2056,2060,2063,2067,2071,2074,2078,2081,//280
	2085,2088,2092,2096,2099,2103,2106,2110,2113,2117,//290
	2121,2124,2128,2131,2135,2138,2142,2145,2149,2153 //300
};

/*
* *******************************************************************************
*                                  Private function prototypes
* *******************************************************************************
*/

/*
* *******************************************************************************
*                                  Private functions
* *******************************************************************************
*/
#if 0
static void Ola_Lock()
{
	pthread_mutex_lock(&ola_mutex_lock);
}

static void Ola_Unlock()
{
	pthread_mutex_unlock(&ola_mutex_lock);
}
#endif

/*
* *******************************************************************************
* MODULE	: LcdLightCtrl
* ABSTRACT	: 显示屏亮度调节
* FUNCTION	: 
* ARGUMENT	: void
* NOTE		: 
* RETURN	:
* CREATE	: 
*			: V0.01
* UPDATE	: 
* *******************************************************************************
*/
int LcdLightCtrl(int pwm)
{
	pwm_ctrl(PWM_LCD, pwm);

	return RESULT_OK;
}

/*
* *******************************************************************************
* MODULE	: GetLIGHT
* ABSTRACT	: 光照强度
* FUNCTION	: 
* ARGUMENT	: void
* NOTE		: 
* RETURN	: 
* CREATE	: 
*			: V0.01
* UPDATE	: 
* *******************************************************************************
*/
int GetLIGHT(void)
{
	g_ADvoltage[1] = ad_read(LIGHT);

	int temp = (g_ADvoltage[1]-0.5)*100;

	return (temp);
}

/*
* *******************************************************************************
* MODULE	: GetTemp
* ABSTRACT	: 获得环境温度
* FUNCTION	: 
* ARGUMENT	: void
* NOTE		: 
* RETURN	: 
* CREATE	: 
*			: V0.01
* UPDATE	: 
* *******************************************************************************
*/
int GetTemp(void)
{
	float v_temp, v_temp1;
	int tmp;
	unsigned int pt1000value;
	int temp = 0;

	g_ADvoltage[0] = ad_read(TEMP);

	v_temp = g_ADvoltage[0] * 1000 * 3300 / 4095;;
	v_temp = v_temp * 1000000;
	v_temp1 = v_temp / 1830000;
	v_temp = v_temp1 * 100 + 450549;
	v_temp1 = 1000000 - v_temp;
	pt1000value = v_temp * 1000 / v_temp1;

	for (tmp = 0; tmp < sizeof(Temp_Table_Pt1000)/sizeof(&Temp_Table_Pt1000); tmp++)
	{
	    if (pt1000value < Temp_Table_Pt1000[tmp])
	    {
	    	temp = tmp;
	        break;
	    }
	}

	return temp;
}

/*
* *******************************************************************************
* MODULE	: GetInputSta
* ABSTRACT	: 获取输入状态
* FUNCTION	: 
* ARGUMENT	: void
* NOTE		: 
* RETURN	: 0-低 1-高
* CREATE	: 
*			: V0.01
* UPDATE	: 
* *******************************************************************************
*/
int GetInputSta(int bit)
{
	int ret = 0;

	ret = ((g_gpb & (1<<bit)) > 0)? 1:0;

	return ret;
}

/*****************************************************************************
* Function		 : SetOutputSta
* Description	 : port-a or b, bit-控制位, ctrl-0低1高
* Input 		 :
* Output		 :
* Return		 :
* Others		 :
* Record
* 1.Date		 :
*	 Author 	 :
*	 Modification:

*****************************************************************************/
void SetOutputSta(int port, int bit, int ctrl)
{
	switch(port)
	{
		case GPA:
				if(ctrl == 1)
				{
					g_ola |= 1 << bit;			//高
				}
				else
				{
					g_ola &= ~(1 << bit);		//低
				}
				break;
		case GPB:
				if(ctrl == 1)
				{
					g_olb |= 1 << bit;			//高
				}
				else
				{
					g_olb &= ~(1 << bit);		//低
				}
				break;
	}

//	mcp23s17_write(g_mcpfd, 0x12, g_ola, g_olb);
}

/*
* *******************************************************************************
* MODULE	: mcp23s17_main
* ABSTRACT	: 功能执行函数
* FUNCTION	: 
* ARGUMENT	: void
* NOTE		: 
* RETURN	: 
* CREATE	: 
*			: V0.01
* UPDATE	: 
* *******************************************************************************
*/
static int mcp23s17_main()
{
	int j = 0x12;
	unsigned char register_val[2];

	memset(register_val, 0, sizeof(register_val));
	mcp23s17_read(g_mcpfd, j, register_val);

	g_gpa = register_val[0];
	g_gpb = register_val[1];

	return RESULT_OK;
}

/*****************************************************************************
* Function		 : Export_Deal
* Description	 : 处理数据，定期读取输入数据和ad数据
* Input 		 : 
* Output		 : 
* Return		 : 
* Others		 : 
* Record
* 1.Date		 : 
*	 Author 	 : 
*	 Modification:
												
*****************************************************************************/
static void *Export_Deal(void *arg)
{
	unsigned long writeTick = 0;

	while (1)
	{
		mcp23s17_main();

		if (abs(get_timetick() - writeTick) > 100)
		{
			writeTick = get_timetick();

//			if ((g_gpa != g_ola) || ((g_gpb&0x03) != (g_olb&0x03)))
			{
//				DEBUG("writeTick");
				mcp23s17_write(g_mcpfd, 0x12, g_ola, g_olb);
			}
		}
		
		usleep(5*1000);
	}

	return NULL;
}

/*****************************************************************************
* Function		 : Export_Init
* Description	 : pwm,spi的IO芯片任务初始化
* Input 		 : 
* Output		 : 
* Return		 : 
* Others		 :
* Record
* 1.Date		 : 
*	 Author 	 : 
*	 Modification:
												
*****************************************************************************/
void Export_Init(void)
{
	g_mcpfd = mcp23s17_init();
	pwm_init();
	sleep(2);
	pthread_create(&thread_export, 0, Export_Deal, NULL);
	return;
}
